{% extends "components/admin_base.html" %}

{% block content %}
<div class="container" style="margin-top: 2rem;">
    <div class="row">
        <div class="col s12">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">
                        <i class="material-icons left">admin_panel_settings</i>
                        Admin Dashboard
                    </span>
                    
                    <div class="row admin-stats">
                        <div class="col s12 m6 l6">
                            <div class="card-panel admin-card admin-metric" style="background:#e8f1fb;">
                                <div class="card-content">
                                    <span class="card-title blue-text text-darken-2">
                                        <i class="material-icons left">people</i>
                                        Total Users
                                    </span>
                                    <h4 class="blue-text text-darken-2" id="totalUsers">{{ users|length }}</h4>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col s12 m6 l6">
                            <div class="card-panel admin-card admin-metric" style="background:#e6f4ea;">
                                <div class="card-content">
                                    <span class="card-title green-text text-darken-2">
                                        <i class="material-icons left">verified_user</i>
                                        Current User
                                    </span>
                                    <p class="green-text text-darken-2">{{ current_user.email }} ({{ current_user.role }})</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col s12">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">
                        <i class="material-icons left">manage_accounts</i>
                        User Management
                        <button class="btn-small waves-effect waves-light right" id="refreshUsers">
                            <i class="material-icons left">refresh</i>Refresh
                        </button>
                    </span>
                    
                    <div class="progress" id="loadingProgress" style="display: none;">
                        <div class="indeterminate"></div>
                    </div>

                    <table class="striped responsive-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Created</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            {% for user in users %}
                            <tr data-user-id="{{ user.id }}">
                                <td>{{ user.id }}</td>
                                <td>{{ user.email }}</td>
                                <td>
                                    <span class="chip {{ 'red' if user.role == 'admin' else 'blue' }} white-text">
                                        {{ user.role }}
                                    </span>
                                </td>
                                <td>{{ user.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="modal">
    <div class="modal-content">
        <h4>Confirm Role Change</h4>
        <p id="confirmMessage"></p>
    </div>
    <div class="modal-footer">
        <button class="modal-close waves-effect waves-green btn-flat">Cancel</button>
        <button class="waves-effect waves-red btn red white-text" id="confirmAction">Confirm</button>
    </div>
</div>

<script>
$(document).ready(function() {
    // Initialize modal
    $('.modal').modal();
    
    let currentAction = null;
    
    // Refresh users
    $('#refreshUsers').click(async function() {
        await loadUsers();
    });
    
    async function loadUsers() {
        try {
            showLoading(true);
            
            const response = await fetch('/admin/api/users');
            const data = await response.json();
            
            if (data.users) {
                updateUsersTable(data.users);
                $('#totalUsers').text(data.users.length);
            }
            
        } catch (error) {
            console.error('Error loading users:', error);
            M.toast({html: 'âŒ Failed to load users', classes: 'red'});
        } finally {
            showLoading(false);
        }
    };
    
    function updateUsersTable(users) {
        const tbody = $('#usersTableBody');
        tbody.empty();
        
        users.forEach(user => {
            const chipColor = user.role === 'admin' ? 'red' : 'blue';
            
            const row = '<tr data-user-id="' + user.id + '">' +
                       '<td>' + user.id + '</td>' +
                       '<td>' + user.email + '</td>' +
                       '<td><span class="chip ' + chipColor + ' white-text">' + user.role + '</span></td>' +
                       '<td>' + new Date(user.created_at).toLocaleString() + '</td>' +
                       '</tr>';
            
            tbody.append(row);
        });
    };

    function showLoading(show) {
        if (show) {
            $('#loadingProgress').show();
        } else {
            $('#loadingProgress').hide();
        }
    };
});
</script>
{% endblock %}
